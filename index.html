<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Circle Escape Game</title>
<style>
    body {
        margin: 0;
        background: black;
        overflow: hidden;
    }
    canvas {
        display: block;
        margin: auto;
        background: #111;
    }
</style>
</head>
<body>
<canvas id="game"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

const centerX = canvas.width / 2;
const centerY = canvas.height / 2;
const circleRadius = 220;
const gapSize = Math.PI / 5;

let rotation = 0;
let balls = [];

let keys = {
    left: false,
    right: false
};

class Ball {
    constructor(x, y, dx, dy) {
        this.x = x;
        this.y = y;
        this.dx = dx;
        this.dy = dy;
        this.radius = 8;
        this.escaped = false;
    }

    update() {
        this.x += this.dx;
        this.y += this.dy;

        const dist = Math.hypot(this.x - centerX, this.y - centerY);

        if (!this.escaped && dist + this.radius >= circleRadius) {
            let angle = Math.atan2(this.y - centerY, this.x - centerX);
            if (angle < 0) angle += Math.PI * 2;

            let gapStart = rotation;
            let gapEnd = rotation + gapSize;

            if (gapEnd > Math.PI * 2) {
                if (angle > gapStart || angle < gapEnd - Math.PI * 2) {
                    this.escape();
                } else {
                    this.bounce(dist);
                }
            } else {
                if (angle > gapStart && angle < gapEnd) {
                    this.escape();
                } else {
                    this.bounce(dist);
                }
            }
        }
    }

    bounce(dist) {
        let normalX = (this.x - centerX) / dist;
        let normalY = (this.y - centerY) / dist;
        let dot = this.dx * normalX + this.dy * normalY;
        this.dx -= 2 * dot * normalX;
        this.dy -= 2 * dot * normalY;
    }

    escape() {
        this.escaped = true;

        // Replace 1 ball with 2 new balls
        balls.push(new Ball(centerX, centerY,
            (Math.random() - 0.5) * 8,
            (Math.random() - 0.5) * 8));

        balls.push(new Ball(centerX, centerY,
            (Math.random() - 0.5) * 8,
            (Math.random() - 0.5) * 8));
    }

    draw() {
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
        ctx.fillStyle = "white";
        ctx.fill();
    }
}

balls.push(new Ball(centerX, centerY, 4, 3));

function drawCircle() {
    ctx.save();
    ctx.translate(centerX, centerY);
    ctx.rotate(rotation);

    ctx.beginPath();
    ctx.arc(0, 0, circleRadius, gapSize, Math.PI * 2);
    ctx.strokeStyle = "cyan";
    ctx.lineWidth = 6;
    ctx.stroke();

    ctx.restore();
}

function update() {
    if (keys.left) rotation -= 0.05;
    if (keys.right) rotation += 0.05;

    balls.forEach(ball => ball.update());
}

function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    drawCircle();

    balls.forEach(ball => ball.draw());

    ctx.fillStyle = "white";
    ctx.font = "18px Arial";
    ctx.fillText("Balls: " + balls.length, 20, 30);
    ctx.fillText("Move Gap: LEFT / RIGHT arrows", 20, 55);
}

function gameLoop() {
    update();
    draw();
    requestAnimationFrame(gameLoop);
}

document.addEventListener("keydown", e => {
    if (e.code === "ArrowLeft") keys.left = true;
    if (e.code === "ArrowRight") keys.right = true;
});

document.addEventListener("keyup", e => {
    if (e.code === "ArrowLeft") keys.left = false;
    if (e.code === "ArrowRight") keys.right = false;
});

gameLoop();
</script>
</body>
</html>
